% Flowcharting techniques for easy maintenance
% Author: Brent Longborough
%Extended Carlos Melian (Spring 2014 for N+3)
\documentclass[x11names]{article}
\usepackage{tikz}
\usepackage[pdftex]{graphicx}
\usetikzlibrary{shapes,arrows,chains}
\begin{document}
\begin{center}
\pagenumbering{empty}
% =================================================
% Set up a few colours
\colorlet{lcfree}{Red3}
\colorlet{lcnorm}{Blue3}
\colorlet{lccong}{Red3}
% -------------------------------------------------
% Set up a new layer for the debugging marks, and make sure it is on
% top
\pgfdeclarelayer{marx}
\pgfsetlayers{main,marx}
% A macro for marking coordinates (specific to the coordinate naming
% scheme used here). Swap the following 2 definitions to deactivate
% marks.
\providecommand{\cmark}[2][]{%
  \begin{pgfonlayer}{marx}
    \node [nmark] at (c#2#1) {#2};
  \end{pgfonlayer}{marx}
  } 
\providecommand{\cmark}[2][]{\relax} 
% -------------------------------------------------
% Start the picture
\begin{tikzpicture}[%
    >=triangle 60,              % Nice arrows; your taste may be different
    start chain=going below,    % General flow is top-to-bottom
    node distance=6mm and 60mm, % Global setup of box spacing
    every join/.style={norm},   % Default linetype for connecting boxes
    ]
% ------------------------------------------------- 
% A few box styles 
% <on chain> *and* <on grid> reduce the need for manual relative
% positioning of nodes
\tikzset{
  base/.style={draw, on chain, on grid, align=center, minimum height=4ex},
  proc/.style={base, rectangle, text width=8em},
  test/.style={base, diamond, aspect=2, text width=5em},
  term/.style={proc, rounded corners,text width=15em},
  coord/.style={coordinate, on chain, on grid, node distance=6mm and 25mm},
  % -------------------------------------------------
  norm/.style={->, draw, lcnorm},
  free/.style={->, draw, lcfree},
  cong/.style={->, draw, lccong},
  it/.style={font={\small\itshape}}
}
\node [proc, densely dotted, it] (p0) {Update database};
\node [term, join]      {FREE ACCESS DATABASE:\\ ISIN\footnote{www.isin.org/isin/}\\};
\node [proc, join] (p1) {EMPIRICAL PATTERNS:\\ Set of metrics:\\ Moving average\\ Synchrony\\ Var-cov matrices\\ Novel metrics?};
\node [proc, join]      {How to sort results from pattern detection?};
\node [term, join] (t1) {Mechanistic models or decisions based on pattern detection?};
\node [term, join] (t1) {If modeling, which parameters and which information do we have about them (Prior distributions)?};
\node [proc, fill=lcfree!25, right=of p1] (p4) {Simulations};
\node [term, join=by free] {How many replicates?};
\node [proc, join=by free] (p5) {ABC};
\node [term, join=by free] (t5) {Posterior distributions given $\epsilon$};
\node [term] (t6) {Bayes factor};
\node [term, join] (p10) {Which model predict best the data? \\ Which empirical data do we need to improve the predictions?\\};
\node [term, join] (p11) {INVESTMENT DECISIONS\\};
\node [term, join] (p12) {25\% Random walk\\ 25\% Experts (collective intelligence)\\ 25\% Our predictions\\ 25\% Maximum diversity\\};

% -------------------------------------------------
\node [coord, right=of t1] (c1)  {}; \cmark{}   
\node [coord, right=of p10] (c6)  {}; \cmark{}     
% -------------------------------------------------
% A couple of boxes have annotations
\node [above=0mm of p4, it] {Check speed, robustness and feasibility};
\node [above=0mm of p8, it] {};
% -------------------------------------------------
\path (t5.south) to node [near start, xshift=1em] {} (t6); 
  \draw [->,lcfree] (t5.south) -- (t6);
\path (t1.east) to node [near start, yshift=1em] {} (c1); 
  \draw [o->,lcfree] (t1.east) -- (c1) |- (p4);
\path (p10.south) -| node [near end, yshift=-3em] {} (c6); 
  \draw [o->,lcfree] (p10.east) -- (c6) |- (p4); 
%\path (p10.west) to node [near start, yshift=1em] {} (p4); 
%  \draw [o->,lcfree] (p10.west) -| (p4); 
%\path (t7.east) to node [yshift=-1em] {} (c7); 
%  \draw [o->,lcfree] (t7.east) -- (c7)  |- (p9);
%\path (t7.west) to node [yshift=-1em] {} (c5); 
%  \draw [*->,lcfree] (t7.west) -- (c5) |- (p5);
% -------------------------------------------------
% A last flourish which breaks all the rules
\draw [->,MediumPurple4, dotted, thick, shorten >=1mm]
  (p10.south) -- ++(5mm,-3mm)  -- ++(27mm,0) 
  |- node [black, near end, yshift=0.75em, it]
    {Update simulations} (p0);
\draw [->,Red3, dotted, thick, shorten >=1mm]
  (p0.south) -- ++ (5mm,-3mm)  -- ++ (-60mm,0) 
  |- node [black, near end, yshift=0.75em, it]
    {1) Codes online data} (p0);
\draw [->,Red3, dotted, thick, shorten >=1mm]
  (p1.south) -- ++ (5mm,-3mm)  -- ++ (-60mm,0) 
  |- node [black, near end, yshift=0.75em, it]
    {2) Codes pattern detection} (p1);
\draw [->,Red3, dotted, thick, shorten >=1mm]
  (t1.south) -- ++ (5mm,-3mm)  -- ++ (-60mm,0) 
  |- node [black, near end, yshift=0.75em, it]
    {3) Codes models} (t1);
\draw [->,Red3, dotted, thick, shorten >=1mm]
  (p11.south) -- ++ (5mm,-3mm)  -- ++ (-60mm,0) 
  |- node [black, near end, yshift=0.75em, it]
    {4) Validation} (p11);
% -------------------------------------------------
\end{tikzpicture}
% =================================================
\vspace{0.2 in}

%\caption{\bf Flow chart summarizing investment strategies}

\end{center}
\end{document}

